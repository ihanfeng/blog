title: ThinkPHP笔记1-项目入口
date: 2013-12-12 14:02:02
categories: ThinkPHP
tags: [ThinkPHP,入口]
---
##**入口文件**

ThinkPHP采用单一入口模式进行项目部署和访问，无论完成什么功能，一个项目都有一个统一（但不一定是唯一）的入口。应该说，所有项目都是从入口文件开始的，并且所有的项目的入口文件是类似的，入口文件中主要包括：

- 定义框架路径、项目路径和项目名称（可选）
- 定义调试模式和运行模式的相关常量（可选）
- 载入框架入口文件（必须）
<!--more -->
首先，在服务器或者本地的Web目录下面创建一个cms目录，并且把下载的ThinkPHP框架的ThinkPHP目录拷贝到cms目录下面，然后在cms目录下面创建一个index.php文件，该文件就是我们要创建项目的入口文件。
新版的入口文件更加简化，默认情况下，只需要在该文件中添加一行代码即可：
{%codeblock lang:php%}
<?php
	//加载框架入口文件
	require "./ThinkPHP/ThinkPHP.php";
?>
{%endcodeblock%}

然后，我们打开浏览器，输入地址并运行：
http://localhost/cms/
就会看到欢迎页面：
![](/img/2013/12/thinkphp-rukou1.jpg)

表示ThinkPHP已经成功执行，这个时候，系统已经在cms下面自动生成了项目相关目录，并写入了初始Action。
![](/img/2013/12/thinkphp-rukou2.jpg)

入口文件并不一定都是指index.php 文件，因为我们可以为不同的项目创建不同的入口文件，例如，前台项目的入口文件为index.php ，后台项目的入口文件可能是admin.php。

##**项目目录**
如上面的图片所示：

生成的项目目录结构和系统目录类似，包括：
目录	说明
Common	项目公共文件目录，一般放置项目的公共函数
Conf	项目配置目录，项目所有的配置文件都放在这里
Lang	项目语言包目录（可选 如果不需要多语言支持 可删除）
Lib	项目类库目录，通常包括Action和Model子目录
Tpl	项目模板目录，支持模板主题
Runtime	项目运行时目录，包括Cache（模板缓存）、Temp（数据缓存）、Data（数据目录）和Logs（日志文件）子目录，如果存在分组的话，则首先是分组目录。

##**部署目录**

当我们实际部署网站的时候，目录结构往往由于项目的复杂而变得复杂。我们推荐的部署目录结构如下：
![](/img/2013/12/thinkphp-rukou3.jpg)

如果采用分组模块的话 可以简化为一个项目目录
![](/img/2013/12/thinkphp-rukou4.jpg)

##**编译项目**
项目编译机制作为ThinkPHP独创的功能特色，从1.0版本就延续至今，编译缓存的基础原理是第一次运行的时候把核心需要加载的文件去掉空白和注释后合并到一个文件中，第二次运行的时候就直接载入编译缓存而无需载入众多的核心文件，因为存在一个预编译的过程，所以还会进行一些相关的目录检测，对于不存在的目录可以自动生成，这个自动生成机制后面还会提到。当第二次执行的时候就会直接载入编译过的缓存文件，从而省去很多IO开销，加快执行速度。项目编译机制对运行没有任何影响，预编译操作和目录检测机制只会执行一次，因此无论在预编译过程中做了多少复杂的操作，对后面的执行没有任何效率的缺失。3.0版本的项目编译更是带来了新的飞跃，包括：

- 首先是合并了2.0体系的核心编译缓存和项目编译缓存，不再生成两个缓存文件；
- 其次是融合了之前ALLINONE模式，直接对本地环境生成设置和常量定义，减少环境判断有效提升性能；
- 更具特色的是新版的编译缓存可以直接替换框架入口甚至网站入口，从某种程度来说，编译后的框架甚至可以脱离框架核心独立运行；
- 还可以通过参数设置，生成的编译缓存载入外部的常量定义文件，便于产品做用户定义；

因为刚才我们并没有开启调试模式，所以第一次运行之后，除了已经自动生成目录结构外，同时也已经生成了编译缓存文件了。
编译缓存文件默认生成在项目的Runtime目录下面，我们可以在App/Runtime目录下面看到有一个`~runtime.php`文件，这个就是编译缓存文件。
如果你使用了模式扩展的话，编译缓存文件名称可能会有所变化，例如，如果你当前用的是REST模式，那么生成的编译缓存文件则会变成`~rest_runtime.php`。

注意：环境改变后需要删除编译缓存文件，也就是说你不能把本地生成的编译缓存拷贝到服务器或者其他环境直接使用。
编译缓存的内容通常包括：系统函数库、系统基础核心类库、核心或者扩展定义的核心行为类库、项目配置文件、项目函数文件。如果希望自己设置目录，可以在入口文件里面更改RUNTIME_PATH常量进行更改，例如：
define('RUNTIME_PATH','./App/temp/');
注意RUNTIME_PATH目录必须设置为可写权限。

除了自定义编译缓存目录之外，还支持自定义编译缓存文件名，例如：
define('RUNTIME_FILE','./App/temp/runtime_cache.php');

接下来要展示一个新版编译缓存的新特性，假如我们之前已经生成了App/Runtime/~runtime.php编译缓存文件，现在我们进行入口文件替换，修改入口文件如下：
{%codeblock lang:php%}
<?php
 // 替换入口文件为编译缓存文件
 require './App/Runtime/~runtime.php';
{%endcodeblock%}

再次执行后运行依然正常，这个时候其实入口已经被编译缓存文件接管了，跳过了框架的入口文件`ThinkPHP/ThinkPHP.php`。
接下来，见证奇迹的时刻到来了^_^，我们把项目的入口文件index.php删除，并且把编译缓存文件拷贝到项目目录下面，更名为index.php，再次执行运行正常，说明我们已经跳过了入口文件，直接以编译缓存文件为项目运行入口了。

##**调试模式**

虽然编译缓存很优秀，但是并不利于开发阶段中调试和排错，我们强烈建议ThinkPHP开发人员在开发阶段始终开启调试模式，方便及时发现隐患问题和分析、解决问题。开启调试模式很简单，只需要在入口文件中增加一行常量定义代码：

{%codeblock lang:php%}
<?php
    //开启调试模式
    define('APP_DEBUG', true);
    //加载框架入口文件
    require './ThinkPHP/ThinkPHP.php';
?>
{%endcodeblock%}
在完成开发阶段部署到生产环境后，只需要删除调试模式定义代码即可切换到部署模式。

开启调试模式后，系统会首先加载系统默认的调试配置文件，然后加载项目的调试配置文件，调试模式的优势在于：
- 开启日志记录，任何错误信息和调试信息都会详细记录，便于调试；
- 关闭模板缓存，模板修改可以即时生效；
- 记录SQL日志，方便分析SQL；
- 关闭字段缓存，数据表字段修改不受缓存影响；
- 严格检查文件大小写（即使是Windows平台），帮助你提前发现Linux部署问题；
- 可以方便用于开发过程的不同阶段，包括开发、测试和演示等任何需要的情况，不同的应用模式可以配置独立的项目配置文件；
